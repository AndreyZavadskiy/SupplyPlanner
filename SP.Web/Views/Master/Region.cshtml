@{
    ViewData["Title"] = "Region";
}

<h1>Справочник регионов и территорий</h1>

<section>
    <div class="col-xl-9">
        <div class="form-row zero-gutters">
            <div class="form-group row col-6">
                <label for="RegionList" class="control-label zero-gutters col-3">Регион</label>
                <select id="RegionList" asp-items="ViewBag.Regions" class="col-9" onchange="setRegionFilter();"></select>
            </div>
            <div class="form-group row button-group-right col-6">
                <button class="btn btn-secondary" onclick="createRegion();">Добавить</button>
                <button class="btn btn-secondary" onclick="editRegion();">Изменить</button>
            </div>
        </div>
    </div>
    
    <div class="col-xl-9">
        <hr class="section-separate"/>
        <table id="TerritoryGrid" class="table table-striped table-bordered nowrap" width="100%" cellspacing="0">
            <thead>
            <tr>
                <th><input type="checkbox" class="selectAll"/></th>
                <th></th>
                <th>Статус</th>
                <th>ID региона</th>
                <th class="exportable-column">Регион</th>
                <th class="exportable-column">Территория</th>
            </tr>
            </thead>
        </table>
    </div>
    
    <div class="modal" id="RegionModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div id="RegionModalContent"></div>
            </div>
        </div>
    </div>

</section>

@section Scripts
{
    <script>
        $(document).ready(function() {
            var d = new Date();
            var todayString = ("0" + d.getDate()).slice(-2) + "." + ("0" + (d.getMonth() + 1)).slice(-2) + "." + d.getFullYear();
            $('#TerritoryGrid').DataTable({
                language: {
                    url: '/lib/datatables/i18n/russian.json'
                },
                orderFixed: [4, 'asc'],
                rowGroup: {
                    dataSrc: 'regionName'
                },
                stateSave: true,
                lengthMenu: [
                    [10, 25, 50, 100, -1],
                    [10, 25, 50, 100, 'Все']
                ],
                ajax: {
                    url: '/Master/LoadTerritoryList',
                    type: 'POST',
                    datatype: 'json'
                },
                columns: [
                    { defaultContent: '' },
                    {
                        render: function(data, type, full, meta) {
                            return '<a href="/User/' + full.id + '"><img src="/images/pencil-square.svg"/></a>';
                        }
                    },
                    {
                        data: null,
                        render: {
                            '_': 'active',
                            'filter': 'active',
                            'display': function(data, type, full, meta) {
                                if (full.active === '1') return null;
                                else return '<img src="/images/ban-solid-16.png" alt="blocked" title="Территория заблокирована" />';
                            }
                        }
                    },
                    { data: 'regionId' },
                    { data: 'regionName' },
                    { data: 'territoryName' }
                ],
                columnDefs: [
                    {
                        targets: 0,
                        data: null,
                        orderable: false,
                        sorting: false,
                        className: 'select-checkbox',
                        width: '1.5em',
                        visible: false
                    },
                    {
                        targets: 1,
                        orderable: false,
                        sorting: false,
                        width: '1em'
                    },
                    {
                        targets: 2,
                        orderable: false,
                        sorting: false,
                        className: 'dt-center',
                        width: '1em'
                    },
                    {
                        targets: 3,
                        visible: false
                    }
                ],
                dom:
                    "<'row'<'col-sm-12 col-md-6 dt-action-group'B>>" +
                        "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                        "<'row'<'col-sm-12'tr>>" +
                        "<'row'<'col-sm-12 col-md-6'i>>" +
                        "<'row'<'col-sm-12 col-md-6 left-pagination'p>>",
                buttons: [
                    {
                        text: 'Добавить',
                        titleAttr: "Создать нового пользователя",
                        className: 'dt-action-button',
                        action: function(e, dt, node, config) {
                            window.location.href = '/User/Create';
                        }
                    },
                    {
                        text: 'Excel',
                        titleAttr: "Выгрузить таблицу в Excel",
                        className: 'dt-action-button',
                        extend: 'excel',
                        title: 'Список пользователей',
                        messageTop: 'Дата выгрузки ' + todayString,
                        exportOptions: {
                            columns: '.exportable-column',
                            modifier: { search: 'applied' },
                            grouped_array_index: [4]
                        }
                    },
                    {
                        text: 'Фильтры',
                        className: 'dt-action-button filter-button',
                        action: function(e, dt, node, config) {
                            //$('#FilterPane').modal();
                        }
                    }
                ],
                select:
                {
                    style: 'multi',
                    selector:
                        'td:first-child'
                }
            });
            var dt = $('#TerritoryGrid').DataTable();
            // select all checkbox
            $(".selectAll").on("click",
                function(e) {
                    if ($(this).is(":checked")) {
                        dt.rows().select();
                    } else {
                        dt.rows().deselect();
                    }
                });
            // filters
            setRegionFilter();
        });

        function setRegionFilter() {
            var dt = $('#TerritoryGrid').DataTable();
            var searchString = $('#RegionList').val();
            dt.columns(3).search(searchString).draw(false);
        }

        function createRegion() {
            var url = '/Master/CreateRegion';
            $.ajax({
                type: "GET",
                url: url,
                success: function(data) {
                    $('#RegionModalContent').html(data);
                    $('#RegionModal').modal({
                        backdrop: 'static',
                        keyboard: false
                    });
                },
                error: function() {
                    alert('Ошибка открытия формы для создания региона');
                }
            });
        }

        function editRegion() {
            var id = $('#RegionList').val();
            if (id === '') {
                alert('Выберите регион из списка');
                return;
            }
            var url = '/Master/EditRegion';
            $.ajax({
                type: "GET",
                url: url,
                contentType: "application/json; charset=utf-8",
                data: { "id": id },
                datatype: "json",
                success: function(data) {
                    $('#RegionModalContent').html(data);
                    $('#RegionModal').modal({
                        backdrop: 'static',
                        keyboard: false
                    });
                },
                error: function() {
                    alert('Ошибка открытия формы для создания региона');
                }
            });
        }
    </script>
}
